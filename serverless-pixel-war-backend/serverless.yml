service: serverless-pixel-war-backend
frameworkVersion: "4"

custom:
  stage: ${opt:stage, self:provider.stage}
  pixelTopicName: ${self:service}-${self:custom.stage}-pixel-events
  snapshotTopicName: ${self:service}-${self:custom.stage}-snapshot-requests

provider:
  name: aws
  runtime: nodejs20.x
  region: eu-west-3
  stage: dev
  websocketsApiName: ${self:service}-${self:provider.stage}-ws
  memorySize: 128
  timeout: 10
  logRetentionInDays: 30
  httpApi:
    cors:
      allowedOrigins:
        - "*"

  tracing:
    lambda: true
    apiGateway: true
  logs:
    http: true

  environment:
    STAGE: ${self:provider.stage}
    REGION: ${self:provider.region}
    PIXEL_TABLE: pixel_canvas
    RATE_LIMIT_TABLE: pixel_rate_limit
    SNAPSHOT_IMAGE_BUCKET: ${self:service}-${self:provider.stage}-snapshot-images
    SNAPSHOT_REQUEST_TOPIC_ARN: arn:aws:sns:${self:provider.region}:${aws:accountId}:${self:custom.snapshotTopicName}
    PIXEL_QUEUE: pixel-events-queue
    MAX_PIXELS_PER_MINUTE: "20"
    LOG_LEVEL: INFO
    SESSIONS_TABLE: pixel_sessions
    CONNECTIONS_TABLE: pixel_connections
    JWT_SECRET: super-secret-jwt-key
    SNAPSHOT_ADMIN_ID: "285192042693525510"
    BOARD_WIDTH: "256"
    BOARD_HEIGHT: "256"

  iam:
    role:
      statements:
        # Logs Lambda
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: arn:aws:logs:*:*:*
        # Table des pixels
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:Scan
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.PIXEL_TABLE}
        # Table de rate-limit
        - Effect: Allow
          Action:
            - dynamodb:UpdateItem
            - dynamodb:GetItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.RATE_LIMIT_TABLE}
        # SQS
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            - arn:aws:sqs:${self:provider.region}:*:${self:provider.environment.PIXEL_QUEUE}
        # S3 snapshots
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::${self:provider.environment.SNAPSHOT_IMAGE_BUCKET}
            - arn:aws:s3:::${self:provider.environment.SNAPSHOT_IMAGE_BUCKET}/*
        # X-Ray
        - Effect: Allow
          Action:
            - xray:PutTraceSegments
            - xray:PutTelemetryRecords
          Resource: "*"
        # Sessions table
        - Effect: Allow
          Action:
            - dynamodb:PutItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.SESSIONS_TABLE}
        # Connections table
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:GetItem
            - dynamodb:Scan
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/pixel_connections
        # SNS publish
        - Effect: Allow
          Action:
            - sns:Publish
          Resource:
            - arn:aws:sns:${self:provider.region}:*:*

# ======================================================
# Lambda Functions
# ======================================================
functions:
  proxy:
    handler: proxy.handler
    name: ${self:service}-${self:provider.stage}-proxy
    events:
      - httpApi:
          path: /draw
          method: post
    environment:
      QUEUE_URL:
        Ref: PixelEventsQueue

  worker:
    handler: worker.handler
    name: ${self:service}-${self:provider.stage}-worker
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - PixelEventsQueue
              - Arn
    environment:
      PIXEL_TOPIC_ARN: arn:aws:sns:${self:provider.region}:${aws:accountId}:${self:custom.pixelTopicName}

  snapshot:
    handler: snapshot.handler
    name: ${self:service}-${self:provider.stage}-snapshot
    events:
      - httpApi:
          path: /create_snapshot
          method: post
    environment:
      SNAPSHOT_REQUEST_TOPIC_ARN: ${self:provider.environment.SNAPSHOT_REQUEST_TOPIC_ARN}
      SNAPSHOT_ADMIN_ID: ${self:provider.environment.SNAPSHOT_ADMIN_ID}

  snapshotWorker:
    handler: snapshotWorker.handler
    name: ${self:service}-${self:provider.stage}-snapshot-worker
    timeout: 120
    events:
      - sns:
          topicName: ${self:custom.snapshotTopicName}
    environment:
      TABLE_NAME: ${self:provider.environment.PIXEL_TABLE}
      SNAPSHOT_IMAGE_BUCKET: ${self:provider.environment.SNAPSHOT_IMAGE_BUCKET}
      PIXEL_TOPIC_ARN: arn:aws:sns:${self:provider.region}:${aws:accountId}:${self:custom.pixelTopicName}
      BOARD_WIDTH: ${self:provider.environment.BOARD_WIDTH}
      BOARD_HEIGHT: ${self:provider.environment.BOARD_HEIGHT}

  snapshotsList:
    handler: snapshotsList.handler
    name: ${self:service}-${self:provider.stage}-snapshots-list
    events:
      - httpApi:
          path: /snapshots
          method: get
    environment:
      SNAPSHOT_IMAGE_BUCKET: ${self:provider.environment.SNAPSHOT_IMAGE_BUCKET}

  health:
    handler: proxy.handler
    name: ${self:service}-${self:provider.stage}-health
    events:
      - httpApi:
          path: /health
          method: get

  stats:
    handler: proxy.handler
    name: ${self:service}-${self:provider.stage}-stats
    events:
      - httpApi:
          path: /stats
          method: get

  view:
    handler: view.handler
    name: ${self:service}-${self:provider.stage}-view
    events:
      - httpApi:
          path: /view
          method: get
    environment:
      CONNECTIONS_TABLE: pixel_connections

  auth:
    handler: auth.handler
    iamRoleStatements:
      - Effect: Allow
        Action:
          - secretsmanager:GetSecretValue
        Resource: arn:aws:secretsmanager:eu-west-3:326120905293:secret:discord_secret-ea0Iet*
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource:
          - arn:aws:dynamodb:eu-west-3:326120905293:table/${self:provider.environment.SESSIONS_TABLE}
    name: ${self:service}-${self:provider.stage}-auth
    events:
      - httpApi:
          path: /auth
          method: any

  wsConnect:
    handler: wsConnect.handler
    events:
      - websocket:
          route: $connect
    environment:
      CONNECTIONS_TABLE: pixel_connections

  wsDisconnect:
    handler: wsDisconnect.handler
    events:
      - websocket:
          route: $disconnect
    environment:
      CONNECTIONS_TABLE: pixel_connections

  broadcast:
    handler: broadcast.handler
    events:
      - sns:
          topicName: ${self:custom.pixelTopicName}
    environment:
      CONNECTIONS_TABLE: pixel_connections
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
          - dynamodb:DeleteItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/pixel_connections
      - Effect: Allow
        Action:
          - execute-api:ManageConnections
        Resource:
          - arn:aws:execute-api:${self:provider.region}:*:*/*/POST/@connections/*

# ======================================================
# Resources : sqs dynamodb S3
# ======================================================
resources:
  Resources:
    PixelEventsQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:provider.environment.PIXEL_QUEUE}
        VisibilityTimeout: 30

    PixelTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.PIXEL_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pixel_id
            AttributeType: S
        KeySchema:
          - AttributeName: pixel_id
            KeyType: HASH

    PixelRateLimitTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.RATE_LIMIT_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: user_id
            AttributeType: S
          - AttributeName: bucket
            AttributeType: S
        KeySchema:
          - AttributeName: user_id
            KeyType: HASH
          - AttributeName: bucket
            KeyType: RANGE
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

    SnapshotImageBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.SNAPSHOT_IMAGE_BUCKET}
        VersioningConfiguration:
          Status: Enabled
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          IgnorePublicAcls: true
          BlockPublicPolicy: false
          RestrictPublicBuckets: false
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - "*"
              AllowedMethods:
                - GET
                - HEAD
              AllowedHeaders:
                - "*"
              MaxAge: 300

    SnapshotImageBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref SnapshotImageBucket
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Sid: AllowPublicRead
              Effect: Allow
              Principal: "*"
              Action:
                - s3:GetObject
              Resource: arn:aws:s3:::${self:provider.environment.SNAPSHOT_IMAGE_BUCKET}/*

    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.SESSIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: sessionId
            AttributeType: S
        KeySchema:
          - AttributeName: sessionId
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: expiresAt
          Enabled: true

    ConnectionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: pixel_connections
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: connectionId
            AttributeType: S
        KeySchema:
          - AttributeName: connectionId
            KeyType: HASH
