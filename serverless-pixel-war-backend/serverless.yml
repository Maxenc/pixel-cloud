service: serverless-pixel-war-backend
frameworkVersion: "4"

custom:
  stage: ${opt:stage, self:provider.stage}
  # Resource Names
  pixelTable: ${self:service}-${self:custom.stage}-pixels
  gameSessionTable: ${self:service}-${self:custom.stage}-game-sessions
  adminsTable: ${self:service}-${self:custom.stage}-admins
  snapshotsTable: ${self:service}-${self:custom.stage}-snapshots
  logsTable: ${self:service}-${self:custom.stage}-logs
  connectionsTable: ${self:service}-${self:custom.stage}-connections
  sessionsTable: ${self:service}-${self:custom.stage}-sessions
  rateLimitTable: ${self:service}-${self:custom.stage}-ratelimit
  discordSecretName: ${self:service}-${self:custom.stage}-discord-app
  internalApiSecret: ${self:service}-${self:custom.stage}-internal-secret
  # SQS Queues
  drawQueue: ${self:service}-${self:custom.stage}-draw-queue
  drawQueueDLQ: ${self:service}-${self:custom.stage}-draw-queue-dlq
  snapshotQueue: ${self:service}-${self:custom.stage}-snapshot-queue
  snapshotQueueDLQ: ${self:service}-${self:custom.stage}-snapshot-queue-dlq

  # SNS Topics
  pixelEventsTopic: ${self:service}-${self:custom.stage}-pixel-events
  snapshotEventsTopic: ${self:service}-${self:custom.stage}-snapshot-events
  sessionEventsTopic: ${self:service}-${self:custom.stage}-session-events
  errorCriticalTopic: ${self:service}-${self:custom.stage}-error-critical

  # S3
  snapshotBucket: ${self:service}-${self:custom.stage}-snapshot-images

provider:
  name: aws
  runtime: nodejs20.x
  region: eu-west-3
  stage: dev
  memorySize: 128
  timeout: 10
  logRetentionInDays: 30
  environment:
    STAGE: ${self:custom.stage}
    REGION: ${self:provider.region}
    # Tables
    PIXEL_TABLE: ${self:custom.pixelTable}
    GAME_SESSION_TABLE: ${self:custom.gameSessionTable}
    ADMINS_TABLE: ${self:custom.adminsTable}
    SNAPSHOTS_TABLE: ${self:custom.snapshotsTable}
    LOGS_TABLE: ${self:custom.logsTable}
    CONNECTIONS_TABLE: ${self:custom.connectionsTable}
    SESSIONS_TABLE: ${self:custom.sessionsTable}
    RATE_LIMIT_TABLE: ${self:custom.rateLimitTable}
    FRONTEND_URL: "https://d3v8d76h8r7cvq.cloudfront.net"
    PIXEL_API_BASE_URL:
      Fn::Join:
        - ""
        - - "https://"
          - { Ref: HttpApi }
          - ".execute-api."
          - ${self:provider.region}
          - ".amazonaws.com"
    DISCORD_SECRET_NAME: ${self:custom.discordSecretName}
    # Queues
    DRAW_QUEUE_URL: !Ref DrawQueue
    SNAPSHOT_QUEUE_URL: !Ref SnapshotQueue
    # Topics
    PIXEL_EVENTS_TOPIC_ARN: !Ref PixelEventsTopic
    SNAPSHOT_EVENTS_TOPIC_ARN: !Ref SnapshotEventsTopic
    SESSION_EVENTS_TOPIC_ARN: !Ref SessionEventsTopic
    ERROR_CRITICAL_TOPIC_ARN: !Ref ErrorCriticalTopic
    # Buckets
    SNAPSHOT_IMAGE_BUCKET: ${self:custom.snapshotBucket}
    # Config
    BOARD_WIDTH: "256"
    BOARD_HEIGHT: "256"
    MAX_PIXELS_PER_MINUTE: "20"
    INTERNAL_API_SECRET: ${self:custom.internalApiSecret}

  httpApi:
    cors:
      allowedOrigins:
        - "*"
      allowedMethods:
        - GET
        - POST
        - OPTIONS
      allowedHeaders:
        - "*"

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: arn:aws:logs:*:*:*
        - Effect: Allow
          Action:
            - xray:PutTraceSegments
            - xray:PutTelemetryRecords
          Resource: "*"

functions:
  # ======================================================
  # Draw Flow
  # ======================================================
  drawProxy:
    handler: src/handlers/draw/proxy.handler
    events:
      - httpApi:
          path: /draw
          method: post
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource:
          - !GetAtt SessionsTable.Arn
          - !GetAtt GameSessionTable.Arn
          - !GetAtt RateLimitTable.Arn
      - Effect: Allow
        Action:
          - sqs:SendMessage
        Resource: !GetAtt DrawQueue.Arn

  drawWorker:
    handler: src/handlers/draw/worker.handler
    events:
      - sqs:
          arn: !GetAtt DrawQueue.Arn
          batchSize: 10
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource:
          - !GetAtt PixelTable.Arn
          - !GetAtt GameSessionTable.Arn
          - !GetAtt RateLimitTable.Arn
      - Effect: Allow
        Action:
          - sns:Publish
        Resource: !Ref PixelEventsTopic

  # ======================================================
  # Admin / Session Flow
  # ======================================================
  adminSessionPause:
    handler: src/handlers/admin/pause.handler
    events:
      - httpApi:
          path: /admin/session/pause
          method: post
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt AdminsTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource: !GetAtt GameSessionTable.Arn
      - Effect: Allow
        Action:
          - sns:Publish
        Resource: !Ref SessionEventsTopic

  adminSessionResume:
    handler: src/handlers/admin/resume.handler
    events:
      - httpApi:
          path: /admin/session/resume
          method: post
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt AdminsTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource: !GetAtt GameSessionTable.Arn
      - Effect: Allow
        Action:
          - sns:Publish
        Resource: !Ref SessionEventsTopic

  adminSnapshotTrigger:
    handler: src/handlers/admin/snapshotTrigger.handler
    events:
      - httpApi:
          path: /admin/snapshots
          method: post
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt AdminsTable.Arn
      - Effect: Allow
        Action:
          - sqs:SendMessage
        Resource: !GetAtt SnapshotQueue.Arn

  # ======================================================
  # Snapshot Flow
  # ======================================================
  snapshotWorker:
    handler: src/handlers/snapshot/worker.handler
    timeout: 60
    events:
      - sqs:
          arn: !GetAtt SnapshotQueue.Arn
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
          - dynamodb:Query
        Resource: !GetAtt PixelTable.Arn
      - Effect: Allow
        Action:
          - s3:PutObject
        Resource: arn:aws:s3:::${self:custom.snapshotBucket}/*
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: !GetAtt SnapshotsTable.Arn
      - Effect: Allow
        Action:
          - sns:Publish
        Resource: !Ref SnapshotEventsTopic

  snapshotsList:
    handler: src/handlers/snapshot/list.handler
    events:
      - httpApi:
          path: /snapshots
          method: get
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt SnapshotsTable.Arn

  # ======================================================
  # View / Read
  # ======================================================
  view:
    handler: src/handlers/view.handler
    events:
      - httpApi:
          path: /view
          method: get
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt PixelTable.Arn

  state:
    handler: src/handlers/state.handler
    events:
      - httpApi:
          path: /state
          method: get
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt GameSessionTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource:
          - !GetAtt ConnectionsTable.Arn
          - !GetAtt SnapshotsTable.Arn

  # ======================================================
  # Realtime / WebSocket
  # ======================================================
  wsConnect:
    handler: src/handlers/realtime/wsConnect.handler
    events:
      - websocket:
          route: $connect
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:DeleteItem
          - dynamodb:Query
        Resource:
          - !GetAtt ConnectionsTable.Arn
          - !Sub "${ConnectionsTable.Arn}/index/clientIdIndex"

  wsDisconnect:
    handler: src/handlers/realtime/wsDisconnect.handler
    events:
      - websocket:
          route: $disconnect
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:DeleteItem
        Resource: !GetAtt ConnectionsTable.Arn

  broadcast:
    handler: src/handlers/realtime/broadcast.handler
    environment:
      WEBSOCKET_API_ENDPOINT:
        !Join [
          "",
          [
            "https://",
            !Ref WebsocketsApi,
            ".execute-api.",
            "${self:provider.region}",
            ".amazonaws.com/",
            "${self:provider.stage}",
          ],
        ]
    events:
      - sns:
          arn: !Ref PixelEventsTopic
          topicName: ${self:custom.pixelEventsTopic}
      - sns:
          arn: !Ref SnapshotEventsTopic
          topicName: ${self:custom.snapshotEventsTopic}
      - sns:
          arn: !Ref SessionEventsTopic
          topicName: ${self:custom.sessionEventsTopic}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
          - dynamodb:DeleteItem
        Resource: !GetAtt ConnectionsTable.Arn
      - Effect: Allow
        Action:
          - execute-api:ManageConnections
        Resource:
          - arn:aws:execute-api:${self:provider.region}:*:*/*/POST/@connections/*

  # ======================================================
  # Discord Integration
  # ======================================================
  discordInteractions:
    handler: src/handlers/discord/interactions.handler
    events:
      - httpApi:
          path: /discord/interactions
          method: post
    iamRoleStatements:
      - Effect: Allow
        Action:
          - secretsmanager:GetSecretValue
        Resource:
          - arn:aws:secretsmanager:${self:provider.region}:${aws:accountId}:secret:${self:custom.discordSecretName}*

  discordWebhook:
    handler: src/handlers/discord/webhook.handler
    events:
      - sns:
          arn: !Ref SnapshotEventsTopic
          topicName: ${self:custom.snapshotEventsTopic}
    # Needs access to secrets for Discord Webhook URL (store in SSM/SecretsManager usually, but env for now if simple)
    # Assuming we use SSM or environment variables injected securely.
    # Adding basic logging permissions only here as it just calls external API.

  # ======================================================
  # Auth
  # ======================================================
  auth:
    handler: src/handlers/auth.handler
    iamRoleStatements:
      - Effect: Allow
        Action:
          - secretsmanager:GetSecretValue
        Resource: arn:aws:secretsmanager:eu-west-3:326120905293:secret:discord_secret-ea0Iet*
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: !GetAtt SessionsTable.Arn
    events:
      - httpApi:
          path: /auth
          method: any

resources:
  Resources:
    # ================== DynamoDB Tables ==================
    PixelTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.pixelTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: canvasId
            AttributeType: S
          - AttributeName: pixelId
            AttributeType: S
        KeySchema:
          - AttributeName: canvasId
            KeyType: HASH
          - AttributeName: pixelId
            KeyType: RANGE

    GameSessionTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.gameSessionTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: canvasId
            AttributeType: S
        KeySchema:
          - AttributeName: canvasId
            KeyType: HASH

    AdminsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.adminsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: discordUserId
            AttributeType: S
        KeySchema:
          - AttributeName: discordUserId
            KeyType: HASH

    SnapshotsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.snapshotsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: snapshotId
            AttributeType: S
        KeySchema:
          - AttributeName: snapshotId
            KeyType: HASH

    LogsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.logsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: logId
            AttributeType: S
        KeySchema:
          - AttributeName: logId
            KeyType: HASH

    ConnectionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.connectionsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: connectionId
            AttributeType: S
          - AttributeName: clientId
            AttributeType: S
        KeySchema:
          - AttributeName: connectionId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: clientIdIndex
            KeySchema:
              - AttributeName: clientId
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.sessionsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: sessionId
            AttributeType: S
        KeySchema:
          - AttributeName: sessionId
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: expiresAt
          Enabled: true

    RateLimitTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.rateLimitTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: bucket
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: bucket
            KeyType: RANGE
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

    # ================== SQS Queues ==================
    DrawQueueDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.drawQueueDLQ}
        MessageRetentionPeriod: 1209600 # 14 days

    DrawQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.drawQueue}
        VisibilityTimeout: 30
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt DrawQueueDLQ.Arn
          maxReceiveCount: 3

    SnapshotQueueDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.snapshotQueueDLQ}
        MessageRetentionPeriod: 1209600

    SnapshotQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.snapshotQueue}
        VisibilityTimeout: 120
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt SnapshotQueueDLQ.Arn
          maxReceiveCount: 3

    # ================== SNS Topics ==================
    PixelEventsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:custom.pixelEventsTopic}

    SnapshotEventsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:custom.snapshotEventsTopic}

    SessionEventsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:custom.sessionEventsTopic}

    ErrorCriticalTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:custom.errorCriticalTopic}

    # ================== S3 Bucket ==================
    SnapshotImageBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.snapshotBucket}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          IgnorePublicAcls: true
          BlockPublicPolicy: false # Needed for policy below
          RestrictPublicBuckets: false
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - "*"
              AllowedMethods:
                - GET
              AllowedHeaders:
                - "*"
              MaxAge: 300

    SnapshotImageBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref SnapshotImageBucket
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Sid: AllowPublicRead
              Effect: Allow
              Principal: "*"
              Action: "s3:GetObject"
              Resource: !Sub "arn:aws:s3:::${SnapshotImageBucket}/*"

    # ================== EventBridge ==================
    DailySnapshotRule:
      Type: AWS::Events::Rule
      Properties:
        Name: ${self:service}-${self:custom.stage}-daily-snapshot
        ScheduleExpression: "cron(0 12 * * ? *)" # 12:00 PM UTC daily
        State: ENABLED
        Targets:
          - Id: TriggerSnapshotQueue
            Arn: !GetAtt SnapshotQueue.Arn
            Input: '{"canvasId": "main", "triggeredBy": "system-daily"}'

    # Allow EventBridge to push to SQS
    EventBridgeToSnapshotQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - !Ref SnapshotQueue
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: events.amazonaws.com
              Action: sqs:SendMessage
              Resource: !GetAtt SnapshotQueue.Arn
              Condition:
                ArnEquals:
                  aws:SourceArn: !GetAtt DailySnapshotRule.Arn
